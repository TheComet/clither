px = {
  [0.004150, 0.008301, 0.012451, 0.016602, 0.020508, 0.024414, 0.028320, 0.031982, 0.035400],
  [0.035400, 0.038818, 0.041992, 0.044922, 0.047607, 0.050049, 0.052246, 0.054199, 0.056152, 0.057861, 0.059326, 0.061035, 0.062988, 0.065186, 0.067871, 0.070801, 0.073975, 0.077393, 0.081055, 0.084961, 0.089111, 0.093506, 0.098145, 0.103027, 0.108154, 0.113281, 0.118408, 0.123779, 0.129150],
  [0.129150, 0.134521, 0.139893, 0.145264, 0.150635, 0.155762, 0.160889, 0.166016, 0.170898, 0.175537, 0.180176, 0.184570, 0.188721, 0.192627, 0.196289, 0.199707, 0.202881, 0.205811, 0.208252, 0.210449, 0.212402, 0.214111],
  [0.214111, 0.215332, 0.216309, 0.217041, 0.217285, 0.217285, 0.217041, 0.216553, 0.215576, 0.214355, 0.212891, 0.210938, 0.208740, 0.206299, 0.203613, 0.200439, 0.197266, 0.194092, 0.190918, 0.187744, 0.184570],
  [0.184570, 0.181396, 0.178223, 0.175049, 0.171875, 0.168701, 0.165527, 0.162354, 0.159180, 0.156006, 0.152832, 0.149658, 0.146484, 0.143311, 0.140137, 0.136963, 0.133789, 0.130615, 0.127441, 0.124268, 0.121094, 0.117920, 0.114746, 0.111572, 0.108398, 0.105225, 0.102051, 0.098877, 0.095703, 0.092529],
  [0.092529, 0.089355, 0.086182, 0.083008, 0.079834, 0.076660, 0.073486, 0.070312, 0.067139, 0.063965, 0.060791, 0.057617, 0.054443, 0.051270, 0.048096, 0.044922, 0.041748, 0.038574, 0.035400, 0.032227, 0.029053, 0.025879, 0.022705, 0.019531, 0.016357, 0.013184, 0.010010, 0.006836, 0.003662, 0.000488, -0.002686, -0.005859, -0.009033, -0.012207, -0.015381, -0.018555, -0.021729, -0.024902, -0.028076, -0.031250, -0.034424, -0.037598, -0.040771, -0.043945, -0.047119, -0.050293, -0.053467, -0.056641, -0.059814, -0.062988, -0.066162, -0.069336, -0.072510, -0.075684, -0.078857, -0.082031, -0.085205, -0.088379, -0.091553, -0.094727, -0.097900, -0.101074, -0.104248, -0.107422, -0.110596, -0.113770, -0.116943, -0.120117, -0.123291, -0.126465, -0.129639, -0.132812, -0.135986, -0.139160, -0.142334, -0.145508, -0.148682, -0.151855, -0.155029, -0.158203, -0.161377, -0.164551, -0.167725, -0.170898, -0.174072, -0.177246, -0.180420, -0.183594, -0.186768, -0.189941, -0.193115, -0.196289, -0.199463, -0.202637, -0.205811, -0.208984, -0.211914, -0.214844, -0.217529, -0.219971],
  [-0.219971, -0.222168, -0.224365, -0.226074, -0.227539, -0.228760, -0.229736, -0.230225, -0.230469, -0.230469, -0.230225, -0.229980, -0.229492, -0.228760, -0.228027, -0.227295, -0.226318, -0.225342, -0.224365, -0.223145, -0.221680, -0.219971, -0.218018]
};
py = {
  [0.000244, 0.000732, 0.001465, 0.002441, 0.003662, 0.005127, 0.006836, 0.008789, 0.010986],
  [0.010986, 0.013428, 0.016113, 0.018799, 0.021729, 0.024902, 0.028076, 0.031250, 0.034668, 0.038086, 0.041748, 0.045166, 0.048828, 0.052490, 0.056152, 0.059570, 0.062988, 0.066162, 0.069092, 0.072021, 0.074707, 0.077148, 0.079346, 0.081299, 0.082764, 0.083984, 0.084961, 0.085449, 0.085693],
  [0.085693, 0.085693, 0.085449, 0.084961, 0.083984, 0.082764, 0.081299, 0.079346, 0.077148, 0.074707, 0.071777, 0.068604, 0.065186, 0.061523, 0.057617, 0.053467, 0.049072, 0.044434, 0.039795, 0.034912, 0.030029, 0.024902],
  [0.024902, 0.019775, 0.014404, 0.009033, 0.003662, -0.001709, -0.007080, -0.012451, -0.017822, -0.022949, -0.028076, -0.033203, -0.038086, -0.042725, -0.047363, -0.051758, -0.056152, -0.060547, -0.064941, -0.069336, -0.073730],
  [-0.073730, -0.078125, -0.082520, -0.086914, -0.091309, -0.095703, -0.100098, -0.104492, -0.108887, -0.113281, -0.117676, -0.122070, -0.126465, -0.130859, -0.135254, -0.139648, -0.144043, -0.148438, -0.152832, -0.157227, -0.161621, -0.166016, -0.170410, -0.174805, -0.179199, -0.183594, -0.187988, -0.192383, -0.196777, -0.201172],
  [-0.201172, -0.205566, -0.209961, -0.214355, -0.218750, -0.223145, -0.227539, -0.231934, -0.236328, -0.240723, -0.245117, -0.249512, -0.253906, -0.258301, -0.262695, -0.267090, -0.271484, -0.275879, -0.280273, -0.284668, -0.289062, -0.293457, -0.297852, -0.302246, -0.306641, -0.311035, -0.315430, -0.319824, -0.324219, -0.328613, -0.333008, -0.337402, -0.341797, -0.346191, -0.350586, -0.354980, -0.359375, -0.363770, -0.368164, -0.372559, -0.376953, -0.381348, -0.385742, -0.390137, -0.394531, -0.398926, -0.403320, -0.407715, -0.412109, -0.416504, -0.420898, -0.425293, -0.429688, -0.434082, -0.438477, -0.442871, -0.447266, -0.451660, -0.456055, -0.460449, -0.464844, -0.469238, -0.473633, -0.478027, -0.482422, -0.486816, -0.491211, -0.495605, -0.500000, -0.504395, -0.508789, -0.513184, -0.517578, -0.521973, -0.526367, -0.530762, -0.535156, -0.539551, -0.543945, -0.548340, -0.552734, -0.557129, -0.561523, -0.565918, -0.570312, -0.574707, -0.579102, -0.583496, -0.587891, -0.592285, -0.596680, -0.601074, -0.605469, -0.609863, -0.614258, -0.618652, -0.623047, -0.627686, -0.632324, -0.636963],
  [-0.636963, -0.641846, -0.646729, -0.651611, -0.656494, -0.661377, -0.666260, -0.671143, -0.676025, -0.680908, -0.685791, -0.690674, -0.695557, -0.700439, -0.705322, -0.709961, -0.714600, -0.719238, -0.723877, -0.728271, -0.732666, -0.736816, -0.740967]
};

hx = [0.000000, 0.035400, 0.129150, 0.214111, 0.184570, 0.092529, -0.219971, -0.218018];
hy = [0.000000, 0.010986, 0.085693, 0.024902, -0.073730, -0.201172, -0.636963, -0.740967];
ha = [3.139648, -2.534668, 3.139648, 1.834961, 0.879395, 0.945068, 0.989258, 1.976074];
hlf = [2, 9, 9, 9, 13, 45, 10, 0];
hlb = [0, 2, 14, 9, 9, 13, 45, 8];

% Calculate bezier control points
x0 = hx(1:end-1);
x1 = hx(1:end-1) - cos(ha(1:end-1)) .* hlf(1:end-1) / 255;
x2 = hx(2:end) + cos(ha(2:end)) .* hlb(2:end) / 255;
x3 = hx(2:end);

y0 = hy(1:end-1);
y1 = hy(1:end-1) - sin(ha(1:end-1)) .* hlf(1:end-1) / 255;
y2 = hy(2:end) + sin(ha(2:end)) .* hlb(2:end) / 255;
y3 = hy(2:end);

% Calculate polynomial coefficients from control points
a0 = x0;
a1 = -3*x0 + 3*x1;
a2 = 3*x0 - 6*x1 + 3*x2;
a3 = -x0 + 3*x1 - 3*x2 + x3;

b0 = y0;
b1 = -3*y0 + 3*y1;
b2 = 3*y0 - 6*y1 + 3*y2;
b3 = -y0 + 3*y1 - 3*y2 + y3;

hold off
scatter(px0, py0)
daspect([1 1]);
hold on
scatter(px1, py1)
for i = 2:5
  scatter(px{i}, py{i});
end

for i = 1:5
  t = linspace(0, 1, 30);
  x = a0(i) + a1(i)*t + a2(i)*t.^2 + a3(i)*t.^3;
  y = b0(i) + b1(i)*t + b2(i)*t.^2 + b3(i)*t.^3;
  plot(x, y);
  for t = linspace(0, 1, 30)
    x = a0(i) + a1(i)*t + a2(i)*t^2 + a3(i)*t^3;
    y = b0(i) + b1(i)*t + b2(i)*t^2 + b3(i)*t^3;
    dx = a1(i) + 2*a2(i)*t + 3*a3(i)*t^2;
    dy = b1(i) + 2*b2(i)*t + 3*b3(i)*t^2;
    ddx = 2*a2(i) + 6*a3(i)*t;
    ddy = 2*b2(i) + 6*b3(i)*t;
    nx = dy/sqrt(dx*dx + dy*dy);
    ny = -dx/sqrt(dx*dx + dy*dy);

    k = -det([dx, ddx; dy, ddy]) / sqrt(dx*dx + dy*dy)^2;

    l = k*0.01;
    plot([x, x+nx*l], [y, y+ny*l]);
  end
end

