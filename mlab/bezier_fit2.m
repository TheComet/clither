x = [-3018, -3036, -3053, -3068, -3082, -3095, -3106, -3115, -3123, -3129, -3134, -3137, -3139, -3139, -3139, -3138, -3136, -3133, -3129, -3124, -3119, -3113, -3106, -3099, -3091, -3083, -3074, -3065, -3055, -3045, -3034, -3023, -3011, -2998, -2985, -2972, -2958, -2944, -2929, -2914, -2899, -2883, -2867, -2852, -2837, -2822, -2808, -2794, -2781, -2768];
y = [-399, -381, -362, -342, -321, -299, -277, -255, -232, -209, -187, -165, -144, -124, -105, -87, -70, -54, -39, -25, -12, 0, 12, 23, 33, 43, 52, 60, 68, 75, 81, 87, 92, 96, 100, 103, 105, 106, 106, 106, 105, 103, 100, 96, 91, 85, 78, 70, 61, 52];
t = linspace(0, 1, 50);
x = x / 4096;
y = y / 4096;

hold off
scatter(x, y);

r = (t-t(1)).*(t-t(end));
T = [ones(1, 48); t(2:end-1);]';

mx = (x(end)-x(1)) / (t(end)-t(1));
qx = x(1) - mx*t(1);
fx = mx*t + qx;

X = (x(2:end-1) - fx(2:end-1)) ./ r(2:end-1);
cx = (T'*T)^-1 * T' * X';
x0 = qx;
x1 = (mx - cx(1) + 3*x0) / 3;
x2 = (cx(1) - cx(2) - 3*x0 + 6*x1) / 3;
x3 = cx(2) + x0 - 3*x1 + 3*x2;

my = (y(1)-y(end)) / (t(1)-t(end));
qy = y(1) - my*t(1);
fy = my*t + qy;

Y = (y(2:end-1) - fy(2:end-1)) ./ r(2:end-1);
cy = (T'*T)^-1 * T' * Y';
y0 = qy;
y1 = (my - cy(1) + 3*y0) / 3;
y2 = (cy(1) - cy(2) - 3*y0 + 6*y1) / 3;
y3 = cy(2) + y0 - 3*y1 + 3*y2;

fitx = (cx(1) + cx(2)*t) .* r + fx;
fity = (cy(1) + cy(2)*t) .* r + fy;

angle1 = atan2(y1-y0, x1-x0);
angle2 = atan2(y2-y3, x2-x3);
len1 = sqrt((y1-y0)^2+(x1-x0)^2);
len2 = sqrt((y2-y3)^2+(x2-x3)^2);

x1 = x0+cos(angle1)*len1;
y1 = y0+sin(angle1)*len1;
x2 = x3+cos(angle2)*len2;
y2 = y3+sin(angle2)*len2;

a0 = x0;
a1 = -3*x0 + 3*x1;
a2 = 3*x0 - 6*x1 + 3*x2;
a3 = -x0 + 3*x1 - 3*x2 + x3;
fitx = a0 + a1*t + a2*t.^2 + a3*t.^3;

hold on
plot(fitx, fity, 'r');

